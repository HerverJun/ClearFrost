# 清霜视觉检测系统 (ClearFrost) - 开发者指南

## 1. 项目概况
本项目是一个基于 C# (WinForms) 的工业视觉检测软件，主要功能包括：
- **图像采集**：支持多种工业相机（华睿、海康、MindVision等）。
- **视觉算法**：包含模板匹配、形状匹配、YOLO 深度学习检测等。
- **流程控制**：通过流水线（Pipeline）方式组合多个视觉算子。
- **外部通信**：支持与 PLC (Omron/Mitsubishi) 进行信号交互。
- **数据管理**：使用 SQLite 存储配置和检测记录。

## 2. 代码结构
核心代码位于 `ClearFrost` 目录，主要模块划分如下：

### 2.1 核心层 (Core & Program)
- **Program.cs**: 程序的入口点，负责全局异常捕获和应用初始化。
- **主窗口.cs**: 应用程序的主界面逻辑（Form）。
- **BW_yolo.cs**: 封装了 YOLO (OnnxRuntime) 的核心推理逻辑，支持检测、分割、姿态估计。

### 2.2 视觉算法层 (Vision)
位于 `Vision/` 目录，核心类包括：
- **PipelineProcessor.cs**: 视觉流水线处理器，核心逻辑是按顺序执行一系列 `IImageOperator`。
- **GradientShapeMatcher.cs**: 基于梯度的形状匹配算法实现。
- **PyramidShapeMatcher.cs**: 金字塔形状匹配算法。
- **Operators/**: 包含具体的算子实现（如灰度化、模板匹配、YOLO检测算子等）。

### 2.3 业务服务层 (Services)
位于 `Services/` 目录，实现了具体的业务逻辑：
- **IDetectionService / DetectionService.cs**: 封装检测逻辑，管理 YOLO 模型的加载、切换和推理。
- **ICameraService / CameraService.cs**: 相机管理服务，负责相机的搜索、连接、采集。
- **IPlcService / PlcService.cs**: PLC 通信服务，处理触发信号和结果写入。
- **StorageService.cs**: 配置文件的存储与读取。

### 2.4 硬件抽象层 (Hardware)
位于 `Hardware/` 目录：
- **Camera/**: 定义了统一的 `ICamera` 接口，并实现了不同厂商的相机驱动（Huaray, Hikvision, MindVision）。
- **PLC/**: PLC 通信的具体实现。

## 3. 关键流程说明

### 3.1 启动流程
`Program.Main()` -> `ApplicationConfiguration.Initialize()` -> 启动 `主窗口` -> `主窗口.OnInit()` 初始化各类服务 (Camera, PLC, Detection)。

### 3.2 检测流程
1. **触发**: PLC 发送触发信号 -> `PlcService` 收到信号 -> 触发 `TriggerReceived` 事件。
2. **采集**: `CameraService` 捕获图像。
3. **推理**: 图像传入 `DetectionService` 或 `PipelineProcessor`。
    - 如果是 YOLO 模式，调用 `DetectionService.DetectAsync`。
    - 如果是传统算法流水线，调用 `PipelineProcessor.ProcessAsync`。
4. **结果**: 处理结果（合格/不合格、坐标位置）。
5. **输出**: 结果写入 PLC，界面更新显示。

## 4. 开发注意事项
- **多线程**: 图像采集和推理通常在后台线程进行，更新 UI 时需使用 `Invoke`。
- **非托管资源**: 相机句柄、Mat 对象（OpenCvSharp）需要手动释放（Dispose）。
- **异常处理**: global catch 位于 `Program.cs`，主要逻辑中应捕获特定异常并记录日志。

## 5. 依赖库
- **OpenCvSharp4**: 图像处理核心库。
- **Microsoft.ML.OnnxRuntime**: 深度学习推理引擎。
- **System.Data.SQLite**: 本地数据库。

