# 深度学习业务逻辑深度排查报告

- 项目: 清霜视觉检测系统 (ClearFrost)
- 审查时间: 2026-02-28
- 审查范围: 仅深度学习链路（不含传统视觉）
- 审查方法: 静态代码审查（逐文件逐流程核对）

## 0. 结论摘要

当前链路可以运行，但与现场业务目标相比存在若干高风险点，主要集中在:

1. 触发链路的确定性不足（丢触发、异常后监听停摆、部分场景不回写结果）。
2. 模型自动切换与目标标签逻辑不一致（未按“目标标签未检出才切换”实现）。
3. 设置页与后端状态有脱节（相机品牌、辅助模型、自动切换开关的持久化/恢复不完整）。
4. 长时间运行下的恢复能力偏弱（PLC监听异常后不自愈、跨日UI更新存在线程风险）。

## 0.1 你提供的业务逻辑梳理（深度学习SOP）

> 本节是对你原始描述的结构化复述，作为后续排查结论的“目标流程基线”。

### A. 首次部署/换线配置阶段

1. 打开软件。
2. 初次使用或换线时进入设置页，输入管理员密码 `xxgcb`（仅用于现场防误操作，不追求加密强度）。
3. 按现场PLC填写并保存:
   - 物理协议类型
   - PLC IP、端口、触发地址、结果地址
4. 按工位填写并保存:
   - 相机重拍次数与重拍间隔（重拍次数为 `0` 表示关闭重拍）
   - 检测目标标签、目标数量
   - 相机品牌、相机参数
5. 点击“保存并部署”，退出设置页。

### B. 深度学习模式配置阶段

1. 选择“深度学习模式”。
2. 选择主推理模型。
3. 打开“自动切换”。
4. 选择两个辅助小模型（辅助1、辅助2）。
5. 默认任务类型为目标检测；其余阈值采用默认值。

### C. 运行准备阶段

1. 点击“打开相机”。
2. 关注导航栏状态:
   - `Camera` 指示灯应为绿色
   - `PLC` 指示灯应为绿色
3. 若打开相机无响应，需要能快速定位并恢复（这是现场高关注问题）。

### D. 在线检测主循环（核心业务）

1. 等待PLC触发拍照信号。
2. 去抖规则:
   - 若 `2秒` 内收到多个PLC触发，判定为抖动/误发，只处理第一个触发。
3. 触发后动作:
   - 前端触发灯闪烁一次
   - 相机拍照取图
4. 推理与模型切换规则:
   - 先用主模型推理
   - 若未检测到目标 `label`，切换辅助模型1
   - 辅助1仍未检测到，再切换辅助模型2
5. 若仍未检测到目标:
   - 若配置了重拍，则按“重拍次数+重拍间隔”重试，并重复上述推理链
   - 若未配置重拍（或重拍耗尽），输出失败结果给PLC
6. 回PLC规则:
   - 合格 -> 发送放行信号
   - 不合格 -> 输出 NG
7. 伴随数据链:
   - 日志文件增加
   - 计数文件增加
   - 检测流水区域输出本次日志

### E. 长时运行与跨日

1. 重复执行步骤D，支持长期稳定运行（通常 `100h+`）。
2. 跨日后自动重置“今日产出图表”的当日计数，并继续运行。

### F. 业务判定要点（用于验收）

1. 每个“有效触发”必须有且仅有一个最终结果（PASS 或 NG，必要时可扩展 ERROR/TIMEOUT）。
2. 去抖窗口内不能重复计次、重复回写。
3. 主辅模型切换必须围绕“目标标签是否命中”而不是“是否有任意检测框”。
4. 长时间运行中，监听线程、相机线程、存储线程需要可持续，异常可恢复。

## 1. 按现场流程逐项核对

### 1.1 步骤1: 首次设置、保存并部署

实现情况:

- 密码校验为明文比对，满足你“简单防误操作”的诉求。
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1285`
  - 证据: `ClearFrost/Config/AppConfig.cs:47`
- PLC协议/IP/端口/地址、重拍次数与间隔、目标标签与数量可保存。
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1310`
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1314`
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1340`
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1343`
- 保存后会触发“重载YOLO + 尝试重连PLC”。
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1358`
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1361`

偏差与隐患:

- 设置页“相机品牌”没有进入保存映射，后端也未解析该字段，导致“在设置里切换品牌”基本不生效。
  - 前端保存映射中缺失 `cfg-cam-manufacturer`。
  - 证据: `ClearFrost/html/js/ui.js:629`
  - 后端 `OnSaveSettings` 解析中无 Manufacturer 分支。
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1309`
- PLC地址输入框提示 `D100`，但前端会按数字 `parseFloat` 强转，输入 `D100` 会变成 `0`。
  - 证据: `ClearFrost/html/index.html:692`
  - 证据: `ClearFrost/html/js/ui.js:651`
  - 证据: `ClearFrost/html/js/ui.js:660`
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1313`

### 1.2 步骤2: 深度学习模式 + 主/辅模型 + 自动切换

实现情况:

- 支持主模型切换、辅助模型1/2加载、自动切换开关命令。
  - 证据: `ClearFrost/html/index.html:165`
  - 证据: `ClearFrost/html/index.html:205`
  - 证据: `ClearFrost/html/index.html:219`
  - 证据: `ClearFrost/html/js/ui.js:183`
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1210`
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1274`

偏差与隐患:

- 自动切换的核心判定不是“未检测到目标标签”，而是“主模型是否有任意检测框”。
  - `targetLabel` 参数传入了，但 `MultiModelManager` 内未用于切换条件。
  - 证据: `ClearFrost/Core/MultiModelManager.cs:266`
  - 证据: `ClearFrost/Core/MultiModelManager.cs:306`
  - 证据: `ClearFrost/Services/DetectionService.cs:348`
- 启动恢复不完整:
  - 配置里有 `Auxiliary1ModelPath` / `Auxiliary2ModelPath` / `EnableMultiModelFallback`，但冷启动未自动恢复加载。
  - 证据: `ClearFrost/Config/AppConfig.cs:66`
  - 证据: `ClearFrost/Config/AppConfig.cs:71`
  - 证据: `ClearFrost/Config/AppConfig.cs:76`
  - 证据: `ClearFrost/Views/主窗口.Vision.cs:35`
- `EnableFallback` 默认值为 `true`，但 UI 初始只填表单不回写后端，可能出现“界面显示关闭，后端实际开启”。
  - 证据: `ClearFrost/Core/MultiModelManager.cs:107`
  - 证据: `ClearFrost/html/js/ui.js:620`
  - 证据: `ClearFrost/html/js/ui.js:583`
- 保存设置时携带了 `TaskType`，后端并未在 `OnSaveSettings` 中处理该字段。
  - 证据: `ClearFrost/html/js/ui.js:668`
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1309`

### 1.3 步骤3: 点击打开相机，关注 Camera/PLC 绿灯

实现情况:

- 前端有防连点冷却（1.5s）和按钮busy态。
  - 证据: `ClearFrost/html/js/app.js:74`
- 后端有 `_isCameraOpening` 防重入。
  - 证据: `ClearFrost/Views/主窗口.Camera.cs:92`
- 相机打开成功后会更新 Camera 灯并自动连PLC。
  - 证据: `ClearFrost/Views/主窗口.Camera.cs:178`
  - 证据: `ClearFrost/Views/主窗口.Camera.cs:180`

偏差与隐患:

- 打开相机流程是“华睿 SDK 直连路径”，与多品牌相机架构不一致。对于海康路径有较高失败风险。
  - 查找相机固定调用 `MyCamera.IMV_EnumDevices`。
  - 证据: `ClearFrost/Views/主窗口.Camera.cs:45`
  - 海康在 `CameraManager` 里走 `HikvisionCamera` + `CameraProviderAdapter`。
  - 证据: `ClearFrost/Hardware/Camera/CameraManager.cs:287`
  - 证据: `ClearFrost/Hardware/Camera/CameraProviderAdapter.cs:11`
- 打开失败时没有显式把 Camera 状态灯置灰；若之前是绿灯，可能出现假绿状态。
  - 成功分支更新连接状态。
  - 证据: `ClearFrost/Views/主窗口.Camera.cs:178`
  - 失败分支仅日志，无 `UpdateConnection("cam", false)`。
  - 证据: `ClearFrost/Views/主窗口.Camera.cs:182`

### 1.4 步骤4: PLC触发 -> 拍照 -> 主辅模型推理 -> 重拍 -> 回PLC

实现情况:

- 触发监听、软件触发拍照、检测、重拍、结果回写、日志/统计/数据库都已串联。
  - 证据: `ClearFrost/Services/PlcService.cs:188`
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:110`
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:171`
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:244`
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:287`

偏差与隐患:

- 你要求“2秒内多触发只取第一个”未被显式实现。当前仅靠信号量“忙时丢弃”。
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:61`
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:64`
- 触发已消费但可能不回写结果:
  - 无帧时直接 `return`，不会执行回写。
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:154`
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:158`
  - 同时触发位已被监控线程复位。
  - 证据: `ClearFrost/Services/PlcService.cs:219`
- ROI过滤与业务判定不一致:
  - 判定在 `DetectionService` 先做。
  - 证据: `ClearFrost/Services/DetectionService.cs:373`
  - PLC流程再做ROI过滤后没有重算 `IsQualified`。
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:185`
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:210`
- IOU阈值设置存在“配置与实际使用不一致”:
  - 检测实际传入的是 `overlapThreshold`。
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:171`
  - 该值由 `OnThresholdChanged` 更新（ROI阈值事件），不是 `OnSetIou`。
  - 证据: `ClearFrost/Views/主窗口.Init.cs:139`
  - `OnSetIou` 只改配置。
  - 证据: `ClearFrost/Views/主窗口.Init.cs:1195`
- 结果回写没有成功确认链路，失败可被“成功日志”掩盖。
  - 写入失败只发 `ErrorOccurred`，`WriteResultAsync` 不返回成功/失败。
  - 证据: `ClearFrost/Services/PlcService.cs:253`
  - 上层固定打“PLC写入结果”日志。
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:345`

### 1.5 步骤5: 长时间循环（100h+）与跨日统计

实现情况:

- 跨日机制存在两条路径:
  - 每次 `RecordDetection` 前检查跨日。
  - 证据: `ClearFrost/Services/StatisticsService.cs:96`
  - 后台定时器每10分钟检查一次跨日。
  - 证据: `ClearFrost/Services/StatisticsService.cs:84`
- 图片落盘使用有界异步队列，避免无限堆积。
  - 证据: `ClearFrost/Services/ImageSaveQueue.cs:25`
  - 证据: `ClearFrost/Services/ImageSaveQueue.cs:32`

偏差与隐患:

- PLC监听线程异常后直接退出，且不自恢复。
  - 证据: `ClearFrost/Services/PlcService.cs:237`
  - 证据: `ClearFrost/Services/PlcService.cs:242`
- 监听退出时不更新连接状态，UI可能继续显示PLC绿灯但实际上不再监听触发。
  - 证据: `ClearFrost/Services/PlcService.cs:246`
  - 证据: `ClearFrost/Services/PlcService.cs:114`
  - 证据: `ClearFrost/Services/PlcService.cs:143`
- 跨日定时器线程触发 `StatisticsUpdated` 后，UI更新路径未统一切回UI线程，存在线程上下文风险。
  - 定时器触发。
  - 证据: `ClearFrost/Services/StatisticsService.cs:85`
  - 事件订阅未 `InvokeOnUIThread`。
  - 证据: `ClearFrost/Views/主窗口.Init.cs:79`
  - UI方法直接 `ExecuteScriptAsync`。
  - 证据: `ClearFrost/Views/WebUIController.cs:206`
- 数据库无限增长风险:
  - 提供了清理接口但当前流程未调用。
  - 证据: `ClearFrost/Services/SqliteDatabaseService.cs:210`
  - 证据: `ClearFrost/Views/主窗口.PLC.cs:270`

## 2. 高优先级问题清单（执行状态）

| ID | 严重级别 | 问题描述 | 直接影响 | 状态 |
|---|---|---|---|---|
| P0-1 | 高 | 无帧时直接返回，触发已复位但无结果回写 | PLC握手不确定，现场卡死/误判风险 | [x] 已完成（2026-02-28） |
| P0-2 | 高 | PLC监听异常后退出且不自恢复，UI仍可能显示已连接 | 长时运行中“静默停机” | [x] 已完成（2026-02-28） |
| P0-3 | 高 | 模型切换判定未按目标标签逻辑实现 | 业务判定与现场预期不一致 | [x] 已完成（2026-02-28） |
| P0-4 | 高 | 2秒防抖未显式实现，仅忙时丢弃 | 抖动场景下行为不可控 | [x] 已完成（2026-02-28） |
| P0-5 | 高 | 设置页“相机品牌”未持久化，且打开相机流程偏华睿实现 | 多品牌现场落地风险高 | [x] 已完成（2026-02-28） |

## 3. 性能优化点（不改业务语义前提）

- [x] 将非关键路径异步化: 图像保存、数据库写入、部分前端渲染从PLC关键链路解耦。（2026-02-28）
  - 证据: `ClearFrost/Views/主窗口.PLC.cs`
- [x] 增强触发处理策略: 用“有界队列 + 时间窗去抖(2s)”替代“并发即丢”。（2026-02-28）
  - 证据: `ClearFrost/Views/主窗口.PLC.cs`
  - 证据: `ClearFrost/Services/PlcService.cs`
- [x] 精简UI线程负担: PLC触发后的重活尽量避免经 `Invoke` 路径进入UI线程。（2026-02-28）
  - 证据: `ClearFrost/Views/主窗口.Init.cs`
  - 证据: `ClearFrost/Views/WebUIController.cs`
- [x] 统计落盘策略可批量化: 当前每次 `RecordDetection` 都会写盘，长期高节拍下有IO压力。（2026-02-28）
  - 证据: `ClearFrost/Services/StatisticsService.cs`
  - 证据: `ClearFrost/Models/DetectionStatistics.cs`

## 4. 与你现场逻辑的“符合/不符合”结论

- 符合项:
  - 密码防护、协议与参数保存、主/辅模型切换能力、PLC触发到检测再回写主流程、跨日统计机制基本具备。
- 不符合或部分不符合项:
  - （本轮已完成整改）“2秒内只取第一个触发”已按时间窗去抖实现。
  - （本轮已完成整改）“主模型未检出目标label再切辅助”已按label判定实现。
  - （本轮已完成整改）“相机品牌在设置页可切换并生效”已打通持久化与恢复。
  - （本轮已完成整改）PLC监听异常后可自动重连并更新连接状态。

## 5. 建议的排障优先顺序（现场导向）

1. 先修复触发-回写闭环确定性（P0-1、P0-2、P0-4）。
2. 再修复模型切换语义一致性（P0-3）。
3. 再修复设置与设备层一致性（P0-5）。
4. 最后做性能重构（关键路径瘦身、异步化、DB归档清理）。

## 6. 补充说明

- 本轮已按高优先级清单与性能优化点完成代码整改，并已在本报告中勾选状态。
- 该报告聚焦深度学习板块；传统视觉链路未纳入结论。
